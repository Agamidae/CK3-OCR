is_army_in_combat = {
	is_shown = {
		is_army_in_combat = yes
	}
}

add_from_map_outliner = {
	saved_scopes = { target }

	effect = {
		if = {
			limit = {
				NOT = {
					is_target_in_variable_list = {
						name = hostiles_inside
						target = scope:target
					}
				}
				any_player = {
					any_war_enemy = {
						this = scope:target.army_owner
					}
				}
			}
			add_to_variable_list = {
				name = hostile_armies_temp
				target = scope:target
			}
		}
	}
}

sort_armies = {
	effect = {
		clear_variable_list = hostiles_outside

		ordered_in_list = {
			variable = hostile_armies_temp
			min = 0
			order_by = army_size
			root = {
				add_to_variable_list = {
					name = hostiles_outside
					target = prev
				}
			}
		}

		every_in_list = {
			variable = hostiles_outside
			limit = {
				NOT = { exists = this }
			}
			root = {
				remove_list_variable = {
					name = hostiles_outside
					target = prev
				}
			}
		}

		clear_variable_list = hostile_armies_temp
	}
	# remove_variable = refresh_armies
}

clear_allied_units = {
	effect = {
		clear_variable_list = allied_units
	}
}

clear_dead_armies = {
	effect = {
		if = {
			limit = { has_variable_list = allied_units }
			every_in_list = {
				variable = allied_units
				limit = {
					NOT = {
						exists = this
					}
				}
				root = {
					remove_list_variable = {
						name = allied_units
						target = prev
					}
				}
			}
		}
		if = {
			limit = { has_variable_list = hostiles_inside }
			every_in_list = {
				variable = hostiles_inside
				limit = {
					NOT = { exists = this }
				}
				root = {
					remove_list_variable = {
						name = hostiles_inside
						target = prev
					}
				}
			}
			every_in_list = {
				variable = hostiles_inside
				save_scope_as = army

				if = {
					limit = {
						NOT = {
							any_player = {
								OR = {
									any_war_enemy = {
										this = scope:army.army_owner
									}
									any_hostile_raider = {
										this = scope:army.army_owner
									}
								}
								OR = {
									any_realm_province = {
										this = scope:army.location
									}
									any_war_ally = {
										any_realm_province = {
											this = scope:army.location
										}
									}
								}
							}
						}
					}
					root = {
						remove_list_variable = {
							name = hostiles_inside
							target = scope:army
						}
					}
				}
			}
		}
	}
}

is_war_target = {
	saved_scopes = {
		target
	}
	is_shown = {
		any_character_war = {
			casus_belli = {
				any_target_title = {
					trigger_if = {
						limit = {
							exists = title_province
						}
						title_province = {
							this = scope:target
						}
					}
					trigger_else = {
						always = no
					}
				}
			}
		}
	}
}

adjacent_to_war_target = {
	saved_scopes = {
		target
	}
	is_shown = {
		any_character_war = {
			casus_belli = {
				any_target_title = {
					trigger_if = {
						limit = {
							exists = title_province
						}
						title_province = {
							county = {
								any_neighboring_county = {
									title_province = {
										this = scope:target
									}
								}
							}
						}
					}
					trigger_else = {
						always = no
					}
				}
			}
		}
	}
}

you_control = {
	saved_scopes = {
		target
	}
	is_shown = {
		scope:target = {
			barony_controller = {
				NOT = {
					is_at_war_with = root
				}
			}
		}
	}
}

hostile_forts = {
	effect = {
		clear_variable_list = adjacent_hostile_forts
		clear_variable_list = war_targets
		clear_variable_list = hostile_forts
		clear_variable_list = your_hostile_forts

		if = {
			limit = {
				is_at_war = yes
			}
			every_character_war = {
				casus_belli = {
					every_target_title = {
						if = {
							limit = {
								exists = title_province
							}
							title_province = {
								add_to_list = war_targets
							}
						}
					}
				}
			}

			every_war_enemy = {
				every_realm_province = {
					limit = {
						fort_level > 0
						barony_controller = {
							is_at_war_with = root
						}
					}
					add_to_list = hostile_forts
				}
			}

			every_realm_province = {
				limit = {
					fort_level > 0
					barony_controller = {
						is_at_war_with = root
					}
					NOT = {
						is_in_list = hostile_forts
					}
				}
				add_to_list = your_hostile_forts
			}

			every_in_list = {
				list = hostile_forts
				limit = {
					county = {
						save_temporary_scope_as = county
						any_neighboring_county = {
							county_controller = {
								#there's probably a trigger for this
								OR = {
									this = root
									any_liege_or_above = {
										this = root
									}
									any_vassal_or_below = {
										this = root
									}
								}
								NOT = {
									is_at_war_with = root
								}
							}
						}
					}
				}
				root = {
					add_to_variable_list = {
						name = adjacent_hostile_forts
						target = prev
					}
				}
				remove_from_list = hostile_forts
			}

			every_in_list = {
				list = your_hostile_forts
				root = {
					add_to_variable_list = {
						name = your_hostile_forts
						target = prev
					}
				}
			}

			every_in_list = {
				list = hostile_forts
				root = {
					add_to_variable_list = {
						name = hostile_forts
						target = prev
					}
				}
			}
		}
	}
}


#  = {
# 	limit = {
# 		is_at_war = yes
# 	}
# 	every_character_war = {
# 		casus_belli = {
# 			every_target_title = {
# 				if = {
# 					limit = {
# 						exists = title_province
# 					}
# 					title_province = {
# 						add_to_list = war_targets
# 					}
# 				}
# 			}
# 		}
# 	}
# 	every_realm_province = {
# 		limit = {
# 			fort_level > 0
# 			barony_controller = {
# 				is_at_war_with = root
# 			}
# 			NOT = {
# 				is_in_list = war_targets
# 			}
# 		}
# 		add_to_list = your_hostile_forts
# 	}
# 	every_war_enemy = {
# 		every_realm_province = {
# 			limit = {
# 				fort_level > 0
# 				barony_controller = {
# 					is_at_war_with = root
# 				}
# 				NOT = {
# 					is_in_list = war_targets
# 				}
# 				NOT = {
# 					is_in_list = your_hostile_forts
# 				}
# 			}
# 			add_to_list = hostile_forts
# 		}
# 	}
#
# 	every_in_list = {
# 		list = war_targets
# 		root = {
# 			add_to_variable_list = {
# 				name = war_targets
# 				target = prev
# 			}
# 		}
# 	}
# 	every_in_list = {
# 		list = hostile_forts
# 		root = {
# 			add_to_variable_list = {
# 				name = hostile_forts
# 				target = prev
# 			}
# 		}
# 	}
# 	every_in_list = {
# 		list = your_hostile_forts
# 		root = {
# 			add_to_variable_list = {
# 				name = your_hostile_forts
# 				target = prev
# 			}
# 		}
# 	}
# }

# sieges_and_battles = {
# 	effect = {
# 		clear_variable_list = sieges
# 		clear_variable_list = battles
#
# 		every_in_list = {
# 			variable = hostiles_inside
# 			limit = {
# 				OR = {
# 					is_army_in_siege = yes
# 					is_army_in_raid = yes
# 				}
# 				is_army_in_combat = no
# 			}
# 			root = {
# 				add_to_variable_list = {
# 					name = sieges
# 					target = prev
# 				}
# 			}
# 		}
#
# 		every_in_list = {
# 			variable = hostiles_inside
# 			limit = {
# 				is_army_in_combat
# 			}
# 			root = {
# 				add_to_variable_list = {
# 					name = battles
# 					target = prev
# 				}
# 			}
# 		}
# 	}
# }
#
# county_holdings = {
# 	effect = {
# 		if = {
# 			limit = {
# 				NOT = { has_variable_list = adj_holdings }
# 			}
#
# 		}
# 	}
# }